<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MySoul - OS</title>

    <!-- Enlace al Manifest para la PWA -->
    <link rel="manifest" href="manifest.json">

    <!-- Color del tema para la barra de estado en móviles -->
    <meta name="theme-color" content="#000000"/>

    <!-- Scripts y fuentes externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bitcount+Prop+Single:wght@400;600&family=Montserrat:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #000000;
            --text-primary: #FFFFFF;
            --text-secondary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.2);
            --highlight-color: rgba(255, 255, 255, 0.05);
            --card-bg: rgba(24, 24, 24, 0.65); /* Opacidad aumentada */
            --card-border: rgba(255, 255, 255, 0.1);
            --card-glow: rgba(255, 255, 255, 0.05);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* --- Fondo de pantalla y superposición de puntos --- */
        #background-wallpaper {
            position: fixed;
            inset: 0;
            z-index: -2;
            background-size: cover;
            background-position: center;
            filter: blur(20px) brightness(0.8);
            transform: scale(1.1); /* Evita bordes vacíos por el blur */
        }

        #dots-overlay {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.08) 1px, transparent 0);
            background-size: 24px 24px;
        }

        /* --- Estructura Principal --- */
        #onboarding-container,
        #main-os-container,
        #generic-modal {
            display: none;
        }

        #main-os-container.active,
        #onboarding-container.active {
            display: block;
        }

        #main-os-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            opacity: 0;
            animation: fadeInOS 0.8s 0.2s forwards;
        }
        @keyframes fadeInOS { to { opacity: 1; } }

        #main-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }
        
        /* --- Contenedor de Contenido Principal --- */
        #main-content-carousel {
            display: flex;
            overflow-x: hidden;
            scroll-behavior: smooth;
            height: 100vh;
            width: 100vw;
        }

        .dock-content {
            flex: 0 0 100vw;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: start; /* CORREGIDO: para que el contenido no se centre verticalmente */
            justify-content: center;
            perspective: 1200px;
            padding-top: 10rem; /* Aumentado para dar espacio */
            padding-bottom: 8rem;
            padding-left: 1rem;
            padding-right: 1rem;
            box-sizing: border-box;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }
        
        .dock-content.active {
            opacity: 1;
            visibility: visible;
        }


        /* --- Estilos del Carrusel de Apps (Hub) --- */
        #app-carousel-track {
            position: relative;
            width: 100%;
            height: 100%;
            max-height: 500px;
            transform-style: preserve-3d;
            cursor: grab;
        }

        .app-card {
            position: absolute; top: 0; left: 0; right: 0; margin: auto;
            width: clamp(280px, 75vw, 420px); height: 100%;
            background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 24px;
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            user-select: none; display: flex; flex-direction: column;
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s ease;
        }
        .app-card:hover { border-color: rgba(255, 255, 255, 0.3); box-shadow: 0 0 20px 0px var(--card-glow); }
        .app-card.exiting { transform: scale(1.1) !important; opacity: 0 !important; }
        .card-content { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; padding: 2rem; position: relative; z-index: 2; }
        .card-title { font-family: 'Bitcount Prop Single', sans-serif; font-size: clamp(2.5rem, 8vw, 3.5rem); font-weight: 600; line-height: 1; color: var(--text-primary); }
        .card-description { font-size: 1rem; color: var(--text-secondary); margin-top: 0.75rem; max-width: 90%; }
        .card-status { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: var(--text-secondary); letter-spacing: 0.1em; }
        .card-bg-decoration { position: absolute; bottom: -50%; left: -25%; width: 150%; height: 100%; background-image: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 60%); z-index: 1; transition: transform 0.5s ease; }
        .app-card:hover .card-bg-decoration { transform: scale(1.2); }
        .external-app-tag { background-color: rgba(255, 255, 255, 0.1); color: var(--text-secondary); padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-family: 'Roboto Mono', monospace; }

        /* --- Estilos para Contenido de Nuevas Categorías --- */
        .content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; padding: 1.5rem; width: 100%; max-width: 1200px; height: 100%; overflow-y: auto; align-content: start; }
        .small-card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 20px; backdrop-filter: blur(10px); padding: 1.5rem; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.2s ease; }
        .small-card:hover { transform: translateY(-5px); border-color: rgba(255, 255, 255, 0.3); }
        .small-card-title { font-size: 1.5rem; font-weight: 600; }
        .small-card-content { font-size: 1rem; color: var(--text-secondary); }
        .action-button { background-color: rgba(255,255,255,0.1); padding: 0.75rem 1.5rem; border-radius: 99px; text-align: center; transition: background-color 0.2s; cursor: pointer; display: block; margin-top: 1rem; }
        .action-button:hover { background-color: rgba(255,255,255,0.2); }
        .todo-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; }
        .todo-checkbox { width: 1.25rem; height: 1.25rem; background-color: transparent; border: 2px solid var(--border-color); border-radius: 50%; }

        /* --- Barra de Navegación Inferior (Dock) --- */
        #bottom-dock {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            min-width: 180px;
            max-width: min(90vw, 300px);
            background-color: #FFFFFF;
            color: #000000;
            border-radius: 9999px;
            z-index: 150;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.1);
            cursor: grab;
            user-select: none;
        }
        #bottom-dock:active { cursor: grabbing; }

        #dock-text-container {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 42px;
            overflow: hidden;
            padding: 0.75rem 2rem;
        }

        .dock-category-text {
            position: absolute;
            font-size: 1.1rem;
            font-weight: 600;
            white-space: nowrap;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.4s ease;
        }

        /* --- Estilos de Onboarding y Modal --- */
        .onboarding-step { display: none; opacity: 0; position: fixed; inset: 0; z-index: 200; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2rem; background-color: var(--bg-color); transition: opacity 0.5s ease-in-out; }
        .onboarding-step.active { display: flex; opacity: 1; }
        .onboarding-title { font-family: 'Bitcount Prop Single', sans-serif; font-size: 2.5rem; font-weight: 600; letter-spacing: -0.03em; line-height: 1; }
        .onboarding-text { font-size: 1.125rem; color: var(--text-secondary); margin-top: 1rem; max-width: 500px; }
        .hud-item { border: 1px solid var(--border-color); transition: all 0.2s ease; }
        .hud-item:hover { border-color: var(--text-primary); background-color: var(--highlight-color); }
        .hud-button, .input-field { width: 100%; padding: 0.8rem 1.5rem; background: transparent; color: var(--text-primary); font-weight: 500; border: none; outline: none; cursor: pointer; }
        .input-field { border: 1px solid var(--border-color); border-radius: 0.5rem; margin-bottom: 1rem; }
        #fingerprint-button { position: relative; width: 100px; height: 100px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; }
        #fingerprint-button .icon { width: 50px; height: 50px; color: var(--text-secondary); transition: color 0.3s ease; }
        #fingerprint-fill { position: absolute; top: 50%; left: 50%; width: 0; height: 0; background-color: var(--text-primary); border-radius: 50%; transform: translate(-50%, -50%); transition: width 2s ease-out, height 2s ease-out; }
        #fingerprint-button.holding #fingerprint-fill { width: 100px; height: 100px; }
        #fingerprint-button.holding .icon { color: var(--bg-color); z-index: 1; }
        #transition-overlay { position: fixed; inset: 0; background: var(--text-primary); z-index: 250; transform: scale(0); border-radius: 50%; pointer-events: none; transition: transform 0.8s cubic-bezier(0.7, 0, 0.3, 1); }
        #transition-overlay.expand { transform: scale(2.5); }
        .modal-content-wrapper { background-color: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid var(--border-color); padding: 2rem; max-width: 500px; width: 90vw; border-radius: 24px; }
        
        /* --- Estilos para Modal de Ajustes --- */
        #settings-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .settings-tab { padding: 0.75rem 1.5rem; cursor: pointer; color: var(--text-secondary); border-bottom: 2px solid transparent; transition: all 0.2s ease; }
        .settings-tab.active { color: var(--text-primary); border-bottom-color: var(--text-primary); }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; animation: fadeInContent 0.3s forwards; }
        @keyframes fadeInContent { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 640px) {
            #main-header { padding: 1rem 1.5rem; }
            .card-title { font-size: 2.2rem; }
            .card-description { font-size: 0.9rem; }
            .onboarding-title { font-size: 2rem; }
            #bottom-dock { bottom: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Div para el fondo de pantalla -->
    <div id="background-wallpaper"></div>
    <div id="dots-overlay"></div>

    <!-- ================================================================== -->
    <!-- SECCIONES DE ONBOARDING Y MODAL (Sin cambios en la estructura)     -->
    <!-- ================================================================== -->
    <div id="onboarding-container">
        <!-- Paso 1: Bienvenida -->
        <div id="onboarding-step-1" class="onboarding-step">
            <h2 class="onboarding-title">MySoul</h2>
            <p class="onboarding-text">Tu sistema operativo personal. Inicia sesión para sincronizar tus datos en la nube de forma segura.</p>
            <div class="mt-8 space-y-4 max-w-sm mx-auto w-full">
                <div class="hud-item rounded-full"><button id="google-onboarding-btn" class="hud-button">Continuar con Google</button></div>
                <div class="hud-item rounded-full"><button id="local-continue-btn" class="hud-button">Usar sin conexión</button></div>
            </div>
        </div>
        <!-- Paso 2: Introducir Nombre -->
        <div id="onboarding-step-2" class="onboarding-step">
            <h2 class="onboarding-title">¿Cómo te llamas?</h2>
            <p class="onboarding-text">Este nombre se usará para personalizar tu experiencia.</p>
            <div class="mt-8 max-w-sm mx-auto w-full">
                <div class="hud-item rounded-lg"><input type="text" id="username-input" class="input-field text-2xl text-center" placeholder="Tu nombre..."></div>
                <div class="hud-item rounded-full mt-4"><button id="confirm-name-btn" class="hud-button">Confirmar</button></div>
            </div>
        </div>
        <!-- Paso 3: Carta de Compromiso -->
        <div id="onboarding-step-3" class="onboarding-step">
            <div class="flex flex-col items-center justify-between h-full w-full">
                <div class="flex-grow flex flex-col items-center justify-center">
                    <h2 class="onboarding-title">Carta de Compromiso</h2>
                    <p class="onboarding-text">Hoy, sellamos un pacto. Yo, <strong>MySoul</strong>, me comprometo a ser tu compañero constante. Tú, <strong id="commitment-username">Usuario</strong>, te comprometes a interactuar conmigo y a trabajar juntos por tus metas.</p>
                </div>
                <div id="fingerprint-button">
                    <div id="fingerprint-fill"></div>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.864 4.243A7.5 7.5 0 0119.5 12c0 2.42-.943 4.638-2.5 6.312M15.75 9.75A3.75 3.75 0 0112 13.5m-3.75 0A3.75 3.75 0 0112 6.75m-3.75 0a3.75 3.75 0 00-3.75 3.75M9 13.5A3.75 3.75 0 0112 9.75M15 13.5A3.75 3.75 0 0112 17.25m-3.75 0h3.75" /></svg>
                </div>
            </div>
        </div>
    </div>
    <div id="transition-overlay"></div>
    <div id="generic-modal" class="onboarding-step" style="z-index: 300; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px);">
        <div class="modal-content-wrapper">
            <h2 id="generic-modal-title" class="onboarding-title text-2xl">Notificación</h2>
            <div id="generic-modal-text" class="text-left"></div>
            <div id="generic-modal-buttons" class="mt-8 w-full"></div>
        </div>
    </div>

    <!-- ================================================================== -->
    <!-- ESTRUCTURA DEL LAUNCHER / SISTEMA OPERATIVO CON DOCK              -->
    <!-- ================================================================== -->
    <div id="main-os-container" style="display: none;">
        
        <header id="main-header">
            <div id="user-info" class="flex items-center gap-3">
                <img id="user-photo" src="https://placehold.co/40x40/000000/FFFFFF?text=G" alt="Foto de usuario" class="w-10 h-10 rounded-full border-2 border-transparent cursor-pointer transition-all hover:border-white">
                <span id="header-username" class="font-semibold text-lg">Invitado</span>
            </div>
            <div id="system-time" class="font-mono text-lg font-bold text-gray-400">10:42 PM</div>
        </header>

        <!-- Contenedor principal que cambia según la categoría del dock -->
        <!-- ** ORDEN DE SECCIONES ACTUALIZADO ** -->
        <main id="main-content-carousel">
            <!-- 1. Hub -->
            <div id="hub-content" class="dock-content" data-name="Hub">
                <div id="app-carousel-track">
                    <!-- Las tarjetas de apps se generarán dinámicamente aquí -->
                </div>
            </div>
            
            <!-- 2. Accesos -->
            <div id="shortcuts-content" class="dock-content" data-name="Accesos">
                <div id="shortcuts-grid" class="content-grid">
                    <!-- Los accesos directos se generarán dinámicamente aquí -->
                </div>
            </div>
            
            <!-- 3. Tareas (Todos rápidos) -->
            <div id="todos-content" class="dock-content" data-name="Tareas">
                 <div id="todos-grid" class="content-grid">
                    <!-- Los todos se generarán dinámicamente aquí -->
                 </div>
            </div>

            <!-- 4. Notas -->
            <div id="notes-content" class="dock-content" data-name="Notas">
                <div id="notes-grid" class="content-grid">
                    <!-- Las notas se generarán dinámicamente aquí -->
                </div>
            </div>

            <!-- 5. Tiempo -->
            <div id="weather-content" class="dock-content" data-name="Tiempo">
                <div class="content-grid">
                    <div class="small-card"><h3 class="small-card-title">Ahora</h3><p class="small-card-content text-4xl">15°C <span class="text-2xl">☀️</span></p><p class="text-secondary">Despejado</p></div>
                    <div class="small-card"><h3 class="small-card-title">Pronóstico</h3><p class="small-card-content">Tarde: 18°C 🌤️<br>Noche: 12°C 🌙</p></div>
                </div>
            </div>

            <!-- 6. Salud -->
            <div id="health-content" class="dock-content" data-name="Salud">
                <div class="content-grid">
                    <div class="small-card"><h3 class="small-card-title">Pasos Hoy</h3><p class="small-card-content text-4xl">👟 8,452</p></div>
                </div>
            </div>
        </main>
        
        <!-- Barra de Navegación Inferior (Dock) -->
        <nav id="bottom-dock">
            <div id="dock-text-container"></div>
        </nav>
    </div>
    
    <!-- Inputs ocultos para archivos -->
    <input type="file" id="import-file-input" class="hidden" accept=".json">
    <input type="file" id="wallpaper-input" class="hidden" accept="image/*">

    <script type="module">
        // Mock de Firebase para desarrollo local sin conexión
        const auth = { currentUser: null, onAuthStateChanged: (callback) => callback(null) };

        const dataManager = (() => {
            const UNIFIED_STORAGE_KEY = 'mySoul-data-v1';
            
            function getDefaultUnifiedState() { 
                return { 
                    myTime: { 
                        userName: null, 
                        tasks: [], // Inicia vacío
                        wallpaper: null 
                    }, 
                    myMemory: { 
                        memories: [] // Inicia vacío
                    }, 
                    globalSettings: { 
                        onboardingComplete: false,
                        externalApps: [],
                        shortcuts: [] // Inicia vacío
                    } 
                }; 
            }
            function getUnifiedData() { const data = localStorage.getItem(UNIFIED_STORAGE_KEY); if (data) { try { const parsedData = JSON.parse(data); const defaultState = getDefaultUnifiedState(); return { ...defaultState, ...parsedData, myTime: { ...defaultState.myTime, ...(parsedData.myTime || {}) }, myMemory: { ...defaultState.myMemory, ...(parsedData.myMemory || {}) }, globalSettings: { ...defaultState.globalSettings, ...(parsedData.globalSettings || {}) }, }; } catch (error) { console.error("Error al parsear datos unificados, se retorna al estado por defecto:", error); return getDefaultUnifiedState(); } } return getDefaultUnifiedState(); }
            function saveUnifiedData(data) { try { localStorage.setItem(UNIFIED_STORAGE_KEY, JSON.stringify(data)); } catch (error) { console.error("Error al guardar los datos unificados:", error); } }
            return { get: getUnifiedData, save: saveUnifiedData };
        })();

        document.addEventListener('DOMContentLoaded', () => {
            const onboardingContainer = document.getElementById('onboarding-container');
            const mainOsContainer = document.getElementById('main-os-container');
            const genericModal = document.getElementById('generic-modal');
            const modalTitle = document.getElementById('generic-modal-title');
            const modalText = document.getElementById('generic-modal-text');
            const modalButtons = document.getElementById('generic-modal-buttons');

            function showModalAlert(message, title = 'Notificación') { modalTitle.textContent = title; modalText.innerHTML = `<p class="onboarding-text my-4">${message}</p>`; modalButtons.innerHTML = `<div class="hud-item rounded-full"><button id="modal-ok-btn" class="hud-button">Aceptar</button></div>`; genericModal.style.display = 'flex'; genericModal.classList.add('active'); document.getElementById('modal-ok-btn').addEventListener('click', () => { genericModal.classList.remove('active'); setTimeout(() => genericModal.style.display = 'none', 300); }, { once: true }); };
            
            function showAddAppModal() {
                modalTitle.textContent = "Añadir Nueva App";
                modalText.innerHTML = `
                    <p class="onboarding-text mb-4">Introduce los detalles de la nueva tarjeta.</p>
                    <input type="text" id="new-app-title" class="input-field" placeholder="Título de la tarjeta">
                    <input type="text" id="new-app-desc" class="input-field" placeholder="Descripción corta">
                    <input type="url" id="new-app-link" class="input-field" placeholder="https://ejemplo.com">
                `;
                modalButtons.innerHTML = `<div class="flex gap-4"><div class="hud-item rounded-full flex-1"><button id="modal-cancel-btn" class="hud-button">Cancelar</button></div><div class="hud-item rounded-full flex-1 bg-white text-black"><button id="modal-save-app-btn" class="hud-button">Guardar</button></div></div>`;
                genericModal.style.display = 'flex';
                genericModal.classList.add('active');

                const close = () => { genericModal.classList.remove('active'); setTimeout(() => genericModal.style.display = 'none', 300); };

                document.getElementById('modal-cancel-btn').addEventListener('click', close, { once: true });
                document.getElementById('modal-save-app-btn').addEventListener('click', () => {
                    const title = document.getElementById('new-app-title').value.trim();
                    const description = document.getElementById('new-app-desc').value.trim();
                    const link = document.getElementById('new-app-link').value.trim();

                    if (title && description && link) {
                        try {
                            new URL(link); // Validar URL
                            const unifiedData = dataManager.get();
                            unifiedData.globalSettings.externalApps.push({ title, description, href: link });
                            dataManager.save(unifiedData);
                            initializeCarousel(); // Recargar el carrusel
                            close();
                            showModalAlert("¡Nueva app añadida con éxito!");
                        } catch (_) {
                            showModalAlert("Por favor, introduce un enlace válido (URL).");
                        }
                    } else {
                        showModalAlert("Por favor, completa todos los campos.");
                    }
                }, { once: true });
            }
            
            function showAddShortcutModal() {
                modalTitle.textContent = "Nuevo Acceso Directo";
                modalText.innerHTML = `
                    <p class="onboarding-text mb-4">Selecciona el tipo de acceso directo.</p>
                    <div id="shortcut-type-selector" class="flex gap-4 mb-6">
                        <button id="type-call-btn" class="hud-button flex-1 hud-item rounded-full">Llamar</button>
                        <button id="type-app-btn" class="hud-button flex-1 hud-item rounded-full">Abrir App</button>
                    </div>
                    <div id="shortcut-form-container"></div>
                `;
                modalButtons.innerHTML = `<div class="flex gap-4"><div class="hud-item rounded-full flex-1"><button id="modal-cancel-btn" class="hud-button">Cancelar</button></div><div class="hud-item rounded-full flex-1 bg-white text-black"><button id="modal-save-shortcut-btn" class="hud-button text-black font-semibold">Guardar</button></div></div>`;
                
                genericModal.style.display = 'flex';
                genericModal.classList.add('active');

                const formContainer = document.getElementById('shortcut-form-container');
                const typeCallBtn = document.getElementById('type-call-btn');
                const typeAppBtn = document.getElementById('type-app-btn');
                let selectedType = '';

                const callForm = `
                    <input type="text" id="shortcut-name" class="input-field" placeholder="Nombre (Ej: Casa)">
                    <input type="tel" id="shortcut-phone" class="input-field" placeholder="Número de teléfono">
                `;
                const appForm = `
                    <input type="text" id="shortcut-name" class="input-field" placeholder="Nombre de la App (Ej: WhatsApp)">
                    <input type="text" id="shortcut-link" class="input-field" placeholder="Enlace de la App (Ej: whatsapp://)">
                `;

                function selectType(type) {
                    selectedType = type;
                    if (type === 'call') {
                        typeCallBtn.classList.add('bg-white', 'text-black');
                        typeAppBtn.classList.remove('bg-white', 'text-black');
                        formContainer.innerHTML = callForm;
                    } else {
                        typeAppBtn.classList.add('bg-white', 'text-black');
                        typeCallBtn.classList.remove('bg-white', 'text-black');
                        formContainer.innerHTML = appForm;
                    }
                }

                typeCallBtn.addEventListener('click', () => selectType('call'));
                typeAppBtn.addEventListener('click', () => selectType('app'));

                const close = () => { genericModal.classList.remove('active'); setTimeout(() => genericModal.style.display = 'none', 300); };
                document.getElementById('modal-cancel-btn').addEventListener('click', close, { once: true });

                document.getElementById('modal-save-shortcut-btn').addEventListener('click', () => {
                    if (!selectedType) {
                        showModalAlert("Por favor, selecciona un tipo de acceso directo.");
                        return;
                    }

                    const name = document.getElementById('shortcut-name').value.trim();
                    let target;
                    let newShortcut;

                    if (selectedType === 'call') {
                        const phone = document.getElementById('shortcut-phone').value.trim();
                        if (name && phone) {
                            target = `tel:${phone}`;
                            newShortcut = { type: 'call', name, target };
                        }
                    } else { // app
                        const link = document.getElementById('shortcut-link').value.trim();
                        if (name && link) {
                            target = link;
                            newShortcut = { type: 'app', name, target };
                        }
                    }

                    if (newShortcut) {
                        const unifiedData = dataManager.get();
                        if (!unifiedData.globalSettings.shortcuts) {
                            unifiedData.globalSettings.shortcuts = [];
                        }
                        unifiedData.globalSettings.shortcuts.push(newShortcut);
                        dataManager.save(unifiedData);
                        renderShortcuts();
                        close();
                        showModalAlert("¡Acceso directo añadido!");
                    } else {
                        showModalAlert("Por favor, completa todos los campos.");
                    }
                }, { once: true });
                
                selectType('call'); // Seleccionar 'Llamar' por defecto
            }

            function initializeApp() {
                const unifiedData = dataManager.get();
                if (unifiedData.myTime?.wallpaper) { applyWallpaper(unifiedData.myTime.wallpaper); }
                if (unifiedData.globalSettings.onboardingComplete) {
                    onboardingContainer.style.display = 'none';
                    mainOsContainer.style.display = 'block';
                    mainOsContainer.classList.add('active');
                    initializeCarousel();
                    initializeNavigation();
                    renderNotes();
                    renderTodos();
                    renderShortcuts();
                } else {
                    onboardingContainer.style.display = 'block';
                    onboardingContainer.classList.add('active');
                    mainOsContainer.style.display = 'none';
                    showStep(1);
                }
                const timeEl = document.getElementById('system-time');
                function updateSystemTime() { if (timeEl) { const now = new Date(); timeEl.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); } }
                updateSystemTime();
                setInterval(updateSystemTime, 30000);
            }

            auth.onAuthStateChanged((user) => {
                const unifiedData = dataManager.get();
                const userPhoto = document.getElementById('user-photo');
                const headerUsername = document.getElementById('header-username');
                if (user) {
                    userPhoto.src = user.photoURL || `https://placehold.co/40x40/FFFFFF/000000?text=${user.displayName?.charAt(0) || 'U'}`;
                    headerUsername.textContent = user.displayName || 'Usuario';
                    if (!unifiedData.globalSettings.onboardingComplete) { finishOnboarding(); }
                } else {
                    const localUsername = unifiedData.myTime?.userName;
                    headerUsername.textContent = localUsername || 'Invitado';
                    userPhoto.src = `https://placehold.co/40x40/FFFFFF/000000?text=${localUsername?.charAt(0) || 'G'}`;
                }
                userPhoto.onclick = () => { /* Lógica del modal de ajustes */ };
            });

            function showStep(stepNumber) { document.querySelectorAll('.onboarding-step').forEach(s => s.classList.remove('active')); const step = document.getElementById(`onboarding-step-${stepNumber}`); if(step) { step.classList.add('active'); } }
            function finishOnboarding() { const transitionOverlay = document.getElementById('transition-overlay'); transitionOverlay.classList.add('expand'); setTimeout(() => { onboardingContainer.style.display = 'none'; mainOsContainer.style.display = 'block'; mainOsContainer.classList.add('active'); const unifiedData = dataManager.get(); unifiedData.globalSettings.onboardingComplete = true; dataManager.save(unifiedData); initializeApp(); }, 400); setTimeout(() => { transitionOverlay.style.display = 'none'; }, 1200); }
            document.getElementById('local-continue-btn')?.addEventListener('click', () => showStep(2));
            document.getElementById('confirm-name-btn')?.addEventListener('click', () => { const usernameInput = document.getElementById('username-input'); const username = usernameInput.value.trim(); if (username) { const unifiedData = dataManager.get(); if (!unifiedData.myTime) unifiedData.myTime = {}; unifiedData.myTime.userName = username; dataManager.save(unifiedData); document.getElementById('commitment-username').textContent = username; document.getElementById('header-username').textContent = username; showStep(3); } else { showModalAlert('Por favor, introduce un nombre.'); } });
            const fingerprintButton = document.getElementById('fingerprint-button');
            if(fingerprintButton) { let holdTimeout; const startHold = (e) => { e.preventDefault(); fingerprintButton.classList.add('holding'); holdTimeout = setTimeout(finishOnboarding, 2000); }; const endHold = () => { fingerprintButton.classList.remove('holding'); clearTimeout(holdTimeout); }; fingerprintButton.addEventListener('mousedown', startHold); fingerprintButton.addEventListener('mouseup', endHold); fingerprintButton.addEventListener('mouseleave', endHold); fingerprintButton.addEventListener('touchstart', startHold, { passive: true }); fingerprintButton.addEventListener('touchend', endHold); }
            
            function initializeCarousel() {
                const track = document.getElementById('app-carousel-track');
                if (!track) return;
                
                const unifiedData = dataManager.get();
                const internalApps = [
                    { title: 'MyTime', description: 'Gestión de tareas y enfoque para maximizar tu productividad.', href: 'mytime.html', status: '[ SYSTEM ONLINE ]' },
                    { title: 'MyRoute', description: 'Tu compañero de rutas. Rastrea, guarda y revive tus aventuras.', href: 'myroute.html', status: '[ SYSTEM ONLINE ]' },
                    { title: 'MyMemory', description: 'Tu memoria extendida para organizar aficiones, ideas y listas.', href: 'mymemory.html', status: '[ SYSTEM ONLINE ]' }
                ];
                const externalApps = (unifiedData.globalSettings.externalApps || []).map(app => ({ ...app, status: '<span class="external-app-tag">APP EXTERNA</span>' }));
                const addAppCard = { title: 'Añadir App', description: 'Crea un acceso directo a tus aplicaciones y sitios web favoritos.', action: 'add_app', status: '[ + ]' };

                const allApps = [...internalApps, ...externalApps, addAppCard];
                track.innerHTML = allApps.map(app => `
                    <article class="app-card" data-href="${app.href || ''}" data-action="${app.action || ''}">
                        <div class="card-content">
                            <div class="card-header">
                                <h2 class="card-title">${app.title || 'Sin Título'}</h2>
                                <p class="card-description">${app.description || ''}</p>
                            </div>
                            <div class="card-footer"><span class="card-status">${app.status || ''}</span></div>
                        </div>
                        <div class="card-bg-decoration"></div>
                    </article>
                `).join('');

                const cards = Array.from(track.querySelectorAll('.app-card'));
                if (cards.length === 0) return;

                let currentIndex = 0;
                let isDragging = false;
                let startPos = 0;
                let dragOffset = 0;
                const clickThreshold = 10;

                function updateCardPositions(instant = false) {
                    cards.forEach((card, index) => {
                        card.style.transition = instant ? 'none' : 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s ease';
                        const offset = index - currentIndex;
                        const absOffset = Math.abs(offset);
                        let translateX = offset * 50;
                        if (isDragging && index === currentIndex) { translateX += dragOffset / card.clientWidth * 50; }
                        const scale = 1 - absOffset * 0.1;
                        const zIndex = 10 - absOffset;
                        const opacity = 1 - absOffset * 0.3;
                        card.style.transform = `translateX(${translateX}%) scale(${scale})`;
                        card.style.opacity = `${Math.max(0, opacity)}`;
                        card.style.zIndex = `${zIndex}`;
                        card.style.pointerEvents = (offset === 0) ? 'auto' : 'none';
                    });
                }
                
                const getPositionX = (e) => e.type.includes('mouse') ? e.pageX : e.touches[0].clientX;
                const dragStart = (e) => { isDragging = true; startPos = getPositionX(e); dragOffset = 0; track.style.cursor = 'grabbing'; cards.forEach(card => card.style.transition = 'none'); };
                const dragMove = (e) => { if (isDragging) { dragOffset = getPositionX(e) - startPos; updateCardPositions(true); } };
                const dragEnd = () => { if (!isDragging) return; isDragging = false; track.style.cursor = 'grab'; if (dragOffset < -50 && currentIndex < cards.length - 1) { currentIndex++; } if (dragOffset > 50 && currentIndex > 0) { currentIndex--; } dragOffset = 0; updateCardPositions(); };
                
                cards.forEach((card, index) => {
                    card.addEventListener('click', (e) => {
                        if (Math.abs(dragOffset) > clickThreshold) { e.preventDefault(); return; }
                        if (index !== currentIndex) return;

                        if (card.dataset.action === 'add_app') {
                            showAddAppModal();
                        } else if (card.dataset.href) {
                            card.classList.add('exiting'); 
                            setTimeout(() => { window.location.href = card.dataset.href; }, 400); 
                        }
                    });
                });

                const wrapper = document.getElementById('hub-content');
                wrapper.addEventListener('mousedown', dragStart);
                wrapper.addEventListener('touchstart', dragStart, { passive: true });
                wrapper.addEventListener('mousemove', dragMove);
                wrapper.addEventListener('touchmove', dragMove, { passive: true });
                wrapper.addEventListener('mouseup', dragEnd);
                wrapper.addEventListener('mouseleave', dragEnd);
                wrapper.addEventListener('touchend', dragEnd);

                setTimeout(() => { updateCardPositions(true); track.style.visibility = 'visible'; }, 100);
                window.addEventListener('resize', () => updateCardPositions(true));
            }

            // --- LÓGICA DE NAVEGACIÓN POR GESTOS ---
            function initializeNavigation() {
                const contentCarousel = document.getElementById('main-content-carousel');
                const dock = document.getElementById('bottom-dock');
                const textContainer = document.getElementById('dock-text-container');
                const sections = Array.from(contentCarousel.querySelectorAll('.dock-content'));
                
                let currentIndex = 0;
                let isDragging = false;
                let startX = 0;
                let deltaX = 0;
                let currentTextEl, prevTextEl, nextTextEl;

                function setupTextElements() {
                    textContainer.innerHTML = '';
                    currentTextEl = document.createElement('span');
                    currentTextEl.className = 'dock-category-text';
                    currentTextEl.textContent = sections[currentIndex]?.dataset.name || '';
                    prevTextEl = document.createElement('span');
                    prevTextEl.className = 'dock-category-text';
                    prevTextEl.textContent = sections[currentIndex - 1]?.dataset.name || '';
                    nextTextEl = document.createElement('span');
                    nextTextEl.className = 'dock-category-text';
                    nextTextEl.textContent = sections[currentIndex + 1]?.dataset.name || '';
                    textContainer.append(prevTextEl, currentTextEl, nextTextEl);
                    resetTextPositions(false);
                }

                function resetTextPositions(animated = true) {
                    const duration = animated ? '0.4s' : '0s';
                    [currentTextEl, prevTextEl, nextTextEl].forEach(el => { if(el) el.style.transitionDuration = duration; });
                    if(currentTextEl) { currentTextEl.style.transform = 'translateX(0px)'; currentTextEl.style.opacity = '1'; }
                    if(prevTextEl){ prevTextEl.style.transform = 'translateX(-150%)'; prevTextEl.style.opacity = '0'; }
                    if(nextTextEl){ nextTextEl.style.transform = 'translateX(150%)'; nextTextEl.style.opacity = '0'; }
                }

                function updateOnDrag() {
                    if (!isDragging) return;
                    const dragFraction = Math.min(1, Math.abs(deltaX) / (dock.clientWidth * 1.5));
                    currentTextEl.style.transform = `translateX(${deltaX}px)`;
                    currentTextEl.style.opacity = `${1 - dragFraction}`;
                    if (deltaX > 0) { prevTextEl.style.transform = `translateX(calc(-150% + ${deltaX}px))`; prevTextEl.style.opacity = `${dragFraction}`; } 
                    else { nextTextEl.style.transform = `translateX(calc(150% + ${deltaX}px))`; nextTextEl.style.opacity = `${dragFraction}`; }
                }

                function dragStart(e) { isDragging = true; startX = e.pageX || e.touches[0].pageX; [currentTextEl, prevTextEl, nextTextEl].forEach(el => { if(el) el.style.transitionDuration = '0s'; }); }
                function dragMove(e) { if (!isDragging) return; e.preventDefault(); const currentX = e.pageX || e.touches[0].pageX; deltaX = currentX - startX; if ((currentIndex === 0 && deltaX > 0) || (currentIndex === sections.length - 1 && deltaX < 0)) { deltaX /= 2; } requestAnimationFrame(updateOnDrag); }
                function dragEnd() {
                    if (!isDragging) return;
                    isDragging = false;
                    const swipeThreshold = dock.clientWidth / 4;
                    let newIndex = currentIndex;
                    if (deltaX < -swipeThreshold && currentIndex < sections.length - 1) { newIndex++; } 
                    else if (deltaX > swipeThreshold && currentIndex > 0) { newIndex--; }
                    if (newIndex !== currentIndex) { contentCarousel.scrollTo({ left: newIndex * window.innerWidth, behavior: 'smooth' }); } 
                    else { resetTextPositions(true); }
                    deltaX = 0;
                }

                let scrollTimeout;
                contentCarousel.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        const panelWidth = window.innerWidth;
                        const newIndex = Math.round(contentCarousel.scrollLeft / panelWidth);
                        sections.forEach((section, index) => section.classList.toggle('active', index === newIndex));
                        if (newIndex !== currentIndex || !currentTextEl) { currentIndex = newIndex; setupTextElements(); }
                    }, 50);
                });

                dock.addEventListener('mousedown', dragStart);
                dock.addEventListener('touchstart', dragStart, { passive: true });
                window.addEventListener('mousemove', dragMove);
                window.addEventListener('touchmove', dragMove, { passive: true });
                window.addEventListener('mouseup', dragEnd);
                window.addEventListener('touchend', dragEnd);

                sections[0].classList.add('active');
                setupTextElements();
            }

            // --- LÓGICA PARA RENDERIZAR CONTENIDO DINÁMICO ---
            function renderNotes() {
                const notesGrid = document.getElementById('notes-grid');
                if (!notesGrid) return;

                const data = dataManager.get();
                const recentNotes = (data.myMemory?.memories || [])
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 2);

                let contentHTML = '';
                if (recentNotes.length > 0) {
                    contentHTML = recentNotes.map(note => {
                        const content = note.content || ''; 
                        return `
                        <div class="small-card">
                            <h3 class="small-card-title">${note.title || 'Nota sin título'}</h3>
                            <p class="small-card-content">${content.substring(0, 80)}${content.length > 80 ? '...' : ''}</p>
                        </div>
                    `}).join('');
                     notesGrid.innerHTML = `${contentHTML} <a href="mymemory.html" class="action-button col-span-full">Ver más / Editar</a>`;
                } else {
                    contentHTML = `
                        <div class="small-card items-center justify-center text-center col-span-full cursor-pointer" onclick="window.location.href='mymemory.html'">
                            <h3 class="small-card-title">Añadir Nota</h3>
                            <p class="small-card-content text-4xl mt-2">+</p>
                        </div>
                    `;
                    notesGrid.innerHTML = contentHTML;
                }
            }
            
            // ** FUNCIÓN DE RENDERIZADO DE TAREAS CORREGIDA **
            function renderTodos() {
                const todosGrid = document.getElementById('todos-grid');
                if (!todosGrid) return;

                const data = dataManager.get();
                const pendingTodos = (data.myTime?.tasks || []).filter(task => task && !task.completed);

                let contentHTML = '';
                if (pendingTodos.length > 0) {
                    contentHTML = pendingTodos.map(todo => {
                        const subtasks = todo.subtasks || [];
                        const subtasksHTML = (subtasks.length > 0)
                            ? `<div class="mt-2 space-y-1">${subtasks.map(sub => `<p class="text-sm text-gray-400 ml-4">- ${sub.text || ''}</p>`).join('')}</div>`
                            : '';

                        return `
                            <div class="small-card col-span-full">
                                <h3 class="small-card-title">${todo.title || todo.text || 'Tarea sin descripción'}</h3>
                                ${subtasksHTML}
                            </div>
                        `;
                    }).join('');
                    todosGrid.innerHTML = `${contentHTML}<a href="mytime.html" class="action-button col-span-full">Gestionar Tareas</a>`;

                } else {
                    contentHTML = `
                        <div class="small-card items-center justify-center text-center col-span-full cursor-pointer" onclick="window.location.href='mytime.html'">
                            <h3 class="small-card-title">Añadir Tarea</h3>
                            <p class="small-card-content text-4xl mt-2">+</p>
                        </div>
                    `;
                    todosGrid.innerHTML = contentHTML;
                }
            }

            function renderShortcuts() {
                const shortcutsGrid = document.getElementById('shortcuts-grid');
                if (!shortcutsGrid) return;

                const data = dataManager.get();
                const shortcuts = data.globalSettings?.shortcuts || [];

                const shortcutsHTML = shortcuts.map(shortcut => {
                    const icon = shortcut.type === 'call' ? '📞' : '🚀';
                    return `
                        <div class="small-card text-center items-center justify-center cursor-pointer" data-target="${shortcut.target || ''}">
                            <h3 class="small-card-title">${shortcut.name || 'Acceso sin nombre'}</h3>
                            <p class="small-card-content text-4xl mt-2">${icon}</p>
                        </div>
                    `;
                }).join('');

                const addCardHTML = `
                    <div id="add-shortcut-btn" class="small-card text-center items-center justify-center cursor-pointer border-dashed border-2 hover:border-solid">
                        <h3 class="small-card-title">Añadir Acceso</h3>
                        <p class="small-card-content text-4xl mt-2">+</p>
                    </div>
                `;

                shortcutsGrid.innerHTML = shortcutsHTML + addCardHTML;

                shortcutsGrid.querySelectorAll('.small-card[data-target]').forEach(card => {
                    card.addEventListener('click', () => {
                        const target = card.dataset.target;
                        if (target) {
                            window.location.href = target;
                        }
                    });
                });

                document.getElementById('add-shortcut-btn').addEventListener('click', showAddShortcutModal);
            }

            initializeApp();
        });
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('Service Worker registrado con éxito:', registration.scope))
                    .catch(error => console.log('Error al registrar el Service Worker:', error));
            });
        }
    </script>
</body>
</html>
